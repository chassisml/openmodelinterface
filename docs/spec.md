# Open Model Interface Spec

> The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED",  "MAY", and "OPTIONAL" in this document are to be interpreted as described in [RFC 2119](https://datatracker.ietf.org/doc/html/rfc2119).

## Changelog

| Date       | Version | Notes                       |
|------------|---------|-----------------------------|
| 2021-07-26 | 1.0     | Initial version of OMI Spec |

## Requirements

To qualify as an Open Model Interface (OMI) compliant container, a container must pass the following tests.

### OCI compliant

The container image MUST be an [OCI](https://opencontainers.org/) compliant container image, for example it MAY be generated by [`docker build`](https://docs.docker.com/engine/reference/commandline/build/) or [Kaniko](https://github.com/GoogleContainerTools/kaniko).

### Origin tags

The container MUST be tagged (e.g. `tag` in `registry/org/image:tag`) with a unique ID which corresponds to the ID of the model in the upstream model management system.
For example, the container image tag MAY be set to the [MLflow Run ID](https://www.mlflow.org/docs/latest/model-registry.html) which generated the model.

This is to enable provenance tracking from a given model which generated certain inference results to metadata about how the model was trained.
The metadata referred to by the model tag SHOULD record the versions of the code, data and environment that were used to train the model.

### No latest tag at runtime

The container MUST NOT be addressed via the OCI image tag `:latest` when the serving system is configured to refer to the model.
This is to ensure better reproducibility and tracking of which model generated certain inference results.

It is up to the model serving system (or the CI/CD system which is driving it) to keep track of which models were deployed/configured at runtime in order to be able to track back from a given model inference to exactly which version of the model generated that inference.

### Environment variables

The container MUST be configurable with the following environment variables (the values below are just examples):
```yaml
env:
  - name: INTERFACE
    value: kfserving
  - name: HTTP_PORT
    value: "8080"
  - name: PROTOCOL
    value: v1
  - name: MODEL_NAME
    value: digits
```

* `INTERFACE` MUST be the string interface supported, as defined in the interfaces section below.
* `PROTOCOL` MAY be the optional sub-protocol of the given interface
* `MODEL_NAME` MUST be some human-readable name of the model that is to be run inside the container. This CAN be used to switch between different bundled models at runtime
* `HTTP_PORT` MUST be the TCP port that the container should listen on when started

### Declares which interfaces it supports

The container MUST have an [OCI annotation](https://github.com/opencontainers/image-spec/blob/main/annotations.md) of the following form:

```
ml.openmodel.interfaces=["kfserving.v1", "modzy.v2"]
```

Where `ml.openmodel.interfaces` is a JSON formatted list of `.`-delimited (INTERFACE, PROTOCOL) tuples.

This is so that the serving system at runtime can determine whether it supports a given model without trying to run it so that it can give the user fast feedback.

For example, if a container declares that it supports the KFServing v1 API and the Modzy v2 API as per the example above, it MUST support running in both of the following configurations:

```yaml
env:
  - name: INTERFACE
    value: kfserving
  - name: PROTOCOL
    value: v1
```

```yaml
env:
  - name: INTERFACE
    value: modzy
  - name: PROTOCOL
    value: v2
```

### Ports

When started, the container image MUST listen on the TCP port given as the `HTTP_PORT` environment variable.
When a container starts listening on the prescribed port, it MUST adhere to the interface described below corresponding to its configuration.

### Interfaces

The following interfaces are permitted in the spec:

* `kfserving`: Supports the KFServing [v1 REST API](https://github.com/kubeflow/kfserving/blob/master/docs/README.md#data-plane-v1) (INTERFACE=kfserving, PROTOCOL=v1) and/or the [v2 gRPC API](https://github.com/kubeflow/kfserving/tree/master/docs/predict-api/v2) (INTERFACE=kfserving, PROTOCOL=v2)
* `modzy`: Supports the Modzy [v1 REST API](https://models.modzy.com/docs/model-packaging/container-specifications) (INTERFACE=modzy, PROTOCOL=v1) or the Modzy [v2 gRPC API](https://models.modzy.com/docs/model-packaging/container-specifications-v2) (INTERFACE=modzy, PROTOCOL=v2)

OMI compliant container images MUST implement at least the `kfserving.v2` and `modzy.v2` APIs.

The [Chassis](https://chassis.ml) reference implementation implements `kfserving.v1`, `kfserving.v2` and `modzy.v2`.

## Updates to this spec

If an OMI image declares or supports any strings other than the ones defined above, this document MUST be updated with the new interfaces (with links to their upstream protocol specifications), otherwise the container MUST NOT be described as Open Model Interface compliant.

This document can be updated via Pull Request on [GitHub](https://github.com/modzy/openmodelinterface/edit/main/docs/spec.md).
Contributions welcome!
